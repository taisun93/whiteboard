<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whiteboard Sync</title>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100vh; overflow: hidden; scrollbar-width: none; }
    body::-webkit-scrollbar, #app::-webkit-scrollbar, #main::-webkit-scrollbar, .ai-panel-body::-webkit-scrollbar { display: none; }
    body { background: #1a1a2e; color: #eee; font: 14px/1.4 system-ui, sans-serif; display: flex; flex-direction: column; }
    #toolbar { padding: 8px 12px 8px 60px; background: #16213e; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    #status { color: #888; }
    #status.connected { color: #4ade80; }
    #app-title { font-weight: 600; font-size: 15px; color: #e2e8f0; letter-spacing: 0.02em; }
    #main { flex: 1; display: flex; min-height: 0; overflow: hidden; }
    #board-wrap { display: flex; flex-direction: row; flex: 1; min-height: 0; min-width: 0; overflow: hidden; }
    #tool-menu {
      flex-shrink: 0; width: 48px; margin: 12px 0 12px 12px; align-self: flex-start;
      display: flex; flex-direction: column; align-items: center; gap: 0;
      padding: 8px 0;
      background: #f8fafc; border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.06);
      z-index: 20;
    }
    #tool-menu .palette-group { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    #tool-menu .palette-sep { width: 28px; height: 1px; background: #e2e8f0; margin: 6px 0; border: none; }
    #tool-menu button.tool-btn {
      width: 40px; height: 40px; padding: 0; border: none; border-radius: 10px;
      background: transparent; color: #475569; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    #tool-menu button.tool-btn:hover { background: #e2e8f0; color: #1e293b; }
    #tool-menu button.tool-btn.active { background: #3b82f6; color: #fff; }
    #tool-menu button.tool-btn svg { width: 22px; height: 22px; display: block; }
    #tool-menu .color-section { margin-top: 4px; padding-top: 6px; border-top: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; gap: 6px; }
    #tool-menu .color-current { width: 32px; height: 32px; border: 2px solid #000; border-radius: 8px; cursor: pointer; padding: 0; flex-shrink: 0; box-shadow: 0 0 0 1px rgba(255,255,255,0.3); }
    #tool-menu .color-current:hover { border-color: #334155; }
    #tool-menu .color-expanded { display: none; flex-direction: column; align-items: center; gap: 6px; border: 1px solid #000; border-radius: 8px; padding: 6px; margin-top: 4px; }
    #tool-menu .color-section.expanded .color-expanded { display: flex; }
    #tool-menu .color-swatches { display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; max-width: 48px; }
    #tool-menu .color-swatch { width: 18px; height: 18px; border: 2px solid transparent; border-radius: 4px; cursor: pointer; padding: 0; flex-shrink: 0; }
    #tool-menu .color-swatch:hover { border-color: #94a3b8; }
    #tool-menu .color-swatch.active { border-color: #1e293b; box-shadow: 0 0 0 1px #f8fafc; }
    #tool-menu .color-hex { width: 40px; padding: 4px 6px; font-size: 10px; font-family: monospace; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; color: #334155; text-align: center; }
    #tool-menu .color-hex:focus { outline: none; border-color: #3b82f6; }
    #tool-menu .color-hex::placeholder { color: #94a3b8; }
    #board-inner {
      flex: 1; position: relative; min-height: 0; min-width: 0; display: flex; overflow: hidden;
      background: #0f0f1a;
      border-left: 1px solid #1e293b;
      border-right: 1px solid #1e293b;
    }
    #board-inner canvas { display: block; cursor: crosshair; background: #0f0f1a; flex: 1; width: 100%; height: 100%; object-fit: fill; }
    #board-inner.hand-tool canvas { cursor: grab; }
    #board-inner.hand-tool canvas:active { cursor: grabbing; }
    #stickies-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
    #stickies-layer .sticky-note { pointer-events: auto; }
    #board-inner.erase-active .sticky-note,
    #board-inner.erase-active .text-element { pointer-events: none; }
    #text-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
    #text-layer .text-element { pointer-events: auto; }
    .text-element { position: absolute; background: transparent; color: #e2e8f0; border: 1px solid transparent; border-radius: 4px; padding: 4px 8px; font-size: 14px; line-height: 1.4; font-family: inherit; outline: none; min-width: 60px; min-height: 24px; resize: none; }
    .text-element:hover { border-color: rgba(148, 163, 184, 0.4); }
    .text-element:focus { border-color: #64748b; }
    .text-element .text-content { display: block; min-height: 1em; }
    .text-element .text-delete { position: absolute; top: 2px; right: 2px; background: none; border: none; cursor: pointer; padding: 0 4px; font-size: 14px; line-height: 1; color: #64748b; border-radius: 4px; }
    .text-element .text-delete:hover { background: rgba(0,0,0,0.1); color: #1e293b; }
    .sticky-note { position: absolute; pointer-events: auto; background: #fef9c3; color: #1c1917; border: 1px solid #e4d88a; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; flex-direction: column; min-width: 40px; min-height: 32px; overflow: hidden; }
    .sticky-note .sticky-header { display: flex; align-items: center; justify-content: flex-end; padding: 2px 4px; background: rgba(0,0,0,0.06); flex-shrink: 0; }
    .sticky-note .sticky-delete { background: none; border: none; cursor: pointer; padding: 2px 6px; font-size: 14px; line-height: 1; color: #78716c; border-radius: 4px; }
    .sticky-note .sticky-delete:hover { background: rgba(0,0,0,0.1); color: #1c1917; }
    .sticky-note .sticky-body { flex: 1; padding: 6px 8px; font-size: 13px; line-height: 1.4; resize: none; border: none; background: transparent; color: inherit; font-family: inherit; outline: none; overflow: hidden; }
    .sticky-note .sticky-resize-handle { position: absolute; right: 0; bottom: 0; width: 14px; height: 14px; cursor: se-resize; background: linear-gradient(135deg, transparent 0%, transparent 45%, rgba(0,0,0,0.15) 45%, rgba(0,0,0,0.15) 100%); border-radius: 0 0 4px 0; flex-shrink: 0; }
    .sticky-note.selected { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.9); }
    .text-element.selected { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.9); }
    #sidebar { width: 180px; background: #16213e; border-left: 1px solid #1e293b; padding: 12px; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
    #sidebar h2 { margin: 0 0 10px 0; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
    #users-list { display: flex; flex-direction: column; gap: 6px; }
    #users-list span { background: #1e293b; padding: 6px 10px; border-radius: 4px; font-size: 13px; color: #e2e8f0; }
    #login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #1a1a2e; }
    #login-box { background: #16213e; padding: 32px; border-radius: 12px; border: 1px solid #1e293b; width: 280px; }
    #login-box h1 { margin: 0 0 24px 0; font-size: 18px; color: #e2e8f0; }
    #login-box input { width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid #1e293b; border-radius: 6px; background: #0f0f1a; color: #eee; font-size: 14px; box-sizing: border-box; }
    #login-box input::placeholder { color: #64748b; }
    #login-box button { width: 100%; padding: 10px; border: none; border-radius: 6px; background: #3b82f6; color: #fff; font-size: 14px; cursor: pointer; }
    #login-box button:hover { background: #2563eb; }
    #login-box .btn-google { background: #fff; color: #1f2937; border: 1px solid #d1d5db; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
    #login-box .btn-google:hover { background: #f9fafb; border-color: #9ca3af; }
    #login-box .btn-google svg { width: 18px; height: 18px; }
    #login-error { margin-top: 12px; color: #f87171; font-size: 13px; }
    #app { display: none; flex-direction: column; height: 100vh; overflow: hidden; }
    #app.logged-in { display: flex; }
    #ai-command-panel {
      flex-shrink: 0;
      background: #16213e; border-top: 1px solid #1e293b;
      display: flex; flex-direction: column;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
    }
    .ai-panel-body { padding: 12px 14px 16px; max-height: 180px; overflow: hidden; flex-shrink: 0; }
    .ai-panel-label {
      display: block; font-size: 11px; color: #94a3b8; margin-bottom: 6px;
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .ai-command-input {
      width: 100%; padding: 10px 12px; margin-bottom: 10px;
      border: 1px solid #1e293b; border-radius: 6px;
      background: #0f0f1a; color: #e2e8f0; font-size: 14px;
      font-family: inherit; resize: none; min-height: 72px; overflow: hidden;
      box-sizing: border-box;
    }
    .ai-command-input::placeholder { color: #64748b; }
    .ai-command-input:focus { outline: none; border-color: #3b82f6; }
    .ai-panel-actions { display: flex; justify-content: flex-end; }
    .ai-command-run {
      padding: 8px 18px; border: none; border-radius: 6px;
      background: #3b82f6; color: #fff; font-size: 13px; cursor: pointer;
    }
    .ai-command-run:hover { background: #2563eb; }
    .ai-command-run:disabled { opacity: 0.6; cursor: not-allowed; }
    .ai-command-status { font-size: 12px; color: #94a3b8; margin-bottom: 8px; min-height: 1.2em; }
    .ai-command-status.error { color: #f87171; }
    .ai-command-status.success { color: #4ade80; }
    #board-picker {
      position: fixed; inset: 0; z-index: 200;
      background: #1a1a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px;
    }
    #board-picker.hidden { display: none; }
    #board-picker h2 { margin: 0 0 16px 0; font-size: 18px; color: #e2e8f0; }
    #board-picker ul { list-style: none; margin: 0 0 20px 0; padding: 0; width: 100%; max-width: 360px; }
    #board-picker li { margin-bottom: 8px; }
    #board-picker li button {
      width: 100%; padding: 12px 16px; text-align: left; background: #16213e; border: 1px solid #1e293b;
      border-radius: 8px; color: #e2e8f0; font-size: 14px; cursor: pointer;
    }
    #board-picker li button:hover { background: #1e293b; border-color: #334155; }
    #board-picker .new-board { display: flex; gap: 8px; max-width: 360px; width: 100%; margin-top: 8px; }
    #board-picker .new-board input { flex: 1; padding: 10px 12px; border: 1px solid #1e293b; border-radius: 6px; background: #0f0f1a; color: #eee; font-size: 14px; }
    #board-picker .new-board button { padding: 10px 18px; border: none; border-radius: 6px; background: #3b82f6; color: #fff; font-size: 14px; cursor: pointer; }
    #board-picker .new-board button:hover { background: #2563eb; }
  </style>
</head>
<body>
  <div id="login-screen">
    <div id="login-box">
      <h1>Sign in</h1>
      <p style="margin: 0 0 20px 0; color: #94a3b8; font-size: 13px;">Use your Google account to continue.</p>
      <a href="/api/auth/google" id="btn-google" class="btn-google" style="width: 100%; padding: 10px; border-radius: 6px; font-size: 14px; cursor: pointer; text-decoration: none; box-sizing: border-box;">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </a>
      <div id="login-error" aria-live="polite"></div>
    </div>
  </div>
  <div id="app">
  <div id="board-picker" class="hidden" aria-label="Choose a whiteboard">
    <h2>Choose a whiteboard</h2>
    <ul id="board-picker-list"></ul>
    <div class="new-board">
      <input type="text" id="new-board-name" placeholder="New whiteboard name" value="Untitled" />
      <button type="button" id="new-board-btn">Create new</button>
    </div>
  </div>
  <div id="toolbar">
    <span id="status">Connectingâ€¦</span>
    <span id="app-title">Whiteboard</span>
    <button type="button" id="switch-board-btn" class="hidden" style="margin-left: auto; background: none; border: none; color: #94a3b8; font-size: 13px; cursor: pointer;">Switch board</button>
  </div>
  <div id="main">
    <div id="board-wrap">
    <nav id="tool-menu" aria-label="Tools">
      <div class="palette-group">
        <button type="button" id="tool-draw" class="tool-btn active" title="Draw"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg></button>
        <button type="button" id="tool-erase" class="tool-btn" title="Erase"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 16l6-8 12 0-6 8H3z"/><path d="M9 8l6 8"/></svg></button>
        <button type="button" id="tool-fill" class="tool-btn" title="Fill color"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-8"/><path d="M5 11V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v4"/><path d="M12 2v5"/><path d="M9 6l3 3 3-3"/></svg></button>
      </div>
      <hr class="palette-sep" aria-hidden="true" />
      <div class="palette-group">
        <button type="button" id="tool-move" class="tool-btn" title="Hand: drag objects to move, drag empty space to pan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3"/></svg></button>
      </div>
      <hr class="palette-sep" aria-hidden="true" />
      <div class="palette-group">
        <button type="button" id="tool-sticky" class="tool-btn" title="Sticky note"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg></button>
        <button type="button" id="tool-text" class="tool-btn" title="Text"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg></button>
        <button type="button" id="tool-frame" class="tool-btn" title="Frame"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg></button>
      </div>
      <hr class="palette-sep" aria-hidden="true" />
      <div class="palette-group">
        <button type="button" id="tool-rect" class="tool-btn" title="Rectangle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="1"/></svg></button>
        <button type="button" id="tool-circle" class="tool-btn" title="Circle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg></button>
        <button type="button" id="tool-arrow" class="tool-btn" title="Arrow / Connector"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg></button>
      </div>
      <hr class="palette-sep" aria-hidden="true" />
      <div class="color-section" id="color-section">
        <button type="button" id="color-current" class="color-current" title="Click to change color" aria-label="Current color; click to change"></button>
        <div class="color-expanded">
          <div id="color-swatches" class="color-swatches"></div>
          <input type="text" id="color-hex" class="color-hex" placeholder="#" maxlength="7" title="Hex color" aria-label="Hex color" />
        </div>
      </div>
    </nav>
      <div id="board-inner">
        <canvas id="c" width="800" height="500"></canvas>
        <div id="stickies-layer"></div>
        <div id="text-layer"></div>
      </div>
    </div>
    <aside id="sidebar">
      <h2>Online</h2>
      <div id="users-list"></div>
    </aside>
  </div>
  <div id="ai-command-panel">
    <div class="ai-panel-body">
      <label for="ai-command-input" class="ai-panel-label">Describe what you want on the board. Commands will be run by AI.</label>
      <textarea id="ai-command-input" class="ai-command-input" rows="3" placeholder="e.g. Add a sticky note that says Welcome at 100, 100"></textarea>
      <div id="ai-command-status" class="ai-command-status" aria-live="polite"></div>
      <div class="ai-panel-actions">
        <button type="button" id="ai-command-run" class="ai-command-run">Run</button>
      </div>
    </div>
  </div>
  </div>
  <script>
    (function() {
      var loginScreen = document.getElementById('login-screen');
      var appEl = document.getElementById('app');
      var loginError = document.getElementById('login-error');
      var params = new URLSearchParams(window.location.search);
      var err = params.get('error');
      var errMsg = { invalid_callback: 'Invalid sign-in callback.', config: 'Google sign-in not configured.', token: 'Could not get token.', auth_failed: 'Sign-in failed.' }[err] || (err ? 'Sign-in failed.' : '');
      function showApp() {
        loginScreen.style.display = 'none';
        appEl.classList.add('logged-in');
        var s = document.createElement('script');
        s.src = 'app.js';
        document.body.appendChild(s);
      }
      function showLogin() {
        loginScreen.style.display = 'flex';
        appEl.classList.remove('logged-in');
        if (errMsg) loginError.textContent = errMsg;
      }
      var ctrl = new AbortController();
      var t = setTimeout(function() { ctrl.abort(); }, 15000);
      fetch('/api/me', { credentials: 'include', signal: ctrl.signal })
        .then(function(r) {
          clearTimeout(t);
          if (r.ok) return r.json().then(function() { showApp(); });
          showLogin();
        })
        .catch(function() { clearTimeout(t); showLogin(); });
    })();
  </script>
</body>
</html>
